<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fish Adventure: Ultimate Boss</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #01579b; font-family: 'Tahoma', sans-serif; overflow: hidden; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; max-width: 800px; max-height: 600px; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 2px solid #fff; }
        canvas { background: linear-gradient(#4fc3f7, #01579b); display: block; width: 100%; height: 100%; }
        
        .ui-top-bar { position: absolute; top: 0; left: 0; width: 100%; height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; pointer-events: none; z-index: 6; }
        #score-display { color: white; font-weight: bold; font-size: 22px; text-shadow: 2px 2px #000; }
        #high-score-ui { color: #ffeb3b; font-size: 14px; text-shadow: 1px 1px #000; position: absolute; top: 45px; left: 15px; }
        .hp-bar-container { width: 120px; height: 20px; background: #333; border: 2px solid white; border-radius: 10px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #4caf50; transition: 0.1s; }

        #status-alert { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); color: #ffeb3b; font-weight: bold; text-shadow: 2px 2px #000; z-index: 5; text-align: center; pointer-events: none; width: 90%; font-size: 20px; line-height: 1.1; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 10; text-align: center; padding: 20px; box-sizing: border-box; }
        #main-menu, #credits-menu { background: rgba(0, 0, 0, 0.7); }
        
        #game-over { background: rgba(0, 0, 0, 0); opacity: 0; transition: background 3s ease-in, opacity 2s ease-in; pointer-events: none; }
        #game-over.show { background: rgba(0, 0, 0, 1); opacity: 1; pointer-events: auto; }
        .hidden { display: none !important; }

        .menu-btn { padding: 12px 30px; margin: 8px; font-size: 18px; cursor: pointer; border: none; border-radius: 50px; background: #ffeb3b; color: #01579b; font-weight: bold; box-shadow: 0 5px #fbc02d; outline: none; }
        .menu-btn:active { transform: translateY(3px); box-shadow: 0 2px #fbc02d; }
        
        #boss-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; height: 12px; background: #333; border: 2px solid white; border-radius: 10px; display: none; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff1744; }

        #boss-speech { position: absolute; background: white; color: black; padding: 10px 20px; border-radius: 20px; font-weight: bold; display: none; z-index: 8; border: 3px solid #333; box-shadow: 5px 5px 0px rgba(0,0,0,0.2); pointer-events: none; }
        #boss-speech::after { content: ''; position: absolute; bottom: -15px; left: 50%; border-width: 15px 15px 0; border-style: solid; border-color: white transparent; display: block; width: 0; transform: translateX(-50%); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="ui-top-bar">
        <div>
            <div id="score-display">‡πÅ‡∏ï‡πâ‡∏°: 0</div>
            <div id="high-score-ui">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 0</div>
        </div>
        <div class="hp-bar-container"><div id="hp-fill"></div></div>
    </div>
    <div id="status-alert">‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™!</div>
    <div id="boss-ui"><div id="boss-hp-fill"></div></div>
    <div id="boss-speech">‡∏û‡∏µ‡πà‡∏à‡πã‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß</div>

    <div id="main-menu" class="overlay">
        <h1>FISH ADVENTURE</h1>
        <p>‡πÅ‡∏ï‡πâ‡∏°‡∏ñ‡∏∂‡∏á 5,000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™!</p>
        <button class="menu-btn" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
        <button class="menu-btn" onclick="showCredits()">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</button>
    </div>

    <div id="credits-menu" class="overlay hidden">
        <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2>
        <p>‡∏î.‡∏ä.‡∏ä‡∏ç‡∏≤‡∏ô‡∏±‡∏ô‡∏ï‡πå ‡πÄ‡∏î‡∏ä‡∏ß‡∏á‡∏©‡∏≤ ‡∏°.2/4 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 1</p>
        <button class="menu-btn" onclick="backToMainFromCredits()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <div id="game-over" class="overlay hidden">
        <h2 style="font-size: 40px; color: #ff5252; text-shadow: 2px 2px #000;">GAME OVER</h2>
        <p id="final-score" style="font-size: 24px;"></p>
        <p id="new-record" style="color: #ffeb3b; font-weight: bold; display: none;">!!! NEW RECORD !!!</p>
        <button class="menu-btn" onclick="startGame()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        <button class="menu-btn" onclick="quitToMenu()">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hpFill = document.getElementById('hp-fill');
    const bossUi = document.getElementById('boss-ui');
    const bossHpFill = document.getElementById('boss-hp-fill');
    const bossSpeech = document.getElementById('boss-speech');
    const scoreDisplay = document.getElementById('score-display');
    const highScoreUi = document.getElementById('high-score-ui');
    const statusAlert = document.getElementById('status-alert');
    
    let gameRunning = false, score = 0, hp = 100, items = [], explosions = [], bubbles = [], lastHungerUpdate = 0;
    let poisonTimer = 0, bossDefeated = false, bossBullets = [], shockwaves = []; 
    let playerStunTimer = 0, gameLoopId = null;
    let playerDying = false, deathTimer = 0, shatterParticles = [];
    
    let bossDying = false, bossDeathTimer = 0, bossAlpha = 1;
    let bossShatterParticles = [];

    let victoryPhase = false;
    let victoryTimer = 0;
    let difficultyMultiplier = 1.0;

    let highScore = localStorage.getItem('fishGameHighScore') || 0;
    highScoreUi.innerText = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${highScore}`;

    const player = { x: 400, y: 150, targetX: 400, targetY: 150, facing: 1 };
    const boss = { active: false, x: 400, y: 800, hp: 100000, maxHp: 100000, freezeTime: 0, attackTimer: 0, state: 'idle', warningX: -500, targetX: 400, width: 230, height: 140 };

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }

    function playSound(freq, type, duration, vol=0.1) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; 
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function playEatSound(type) {
        if (type === 'food') playSound(650, 'sine', 0.1, 0.3);
        else if (type === 'worm') playSound(750, 'sine', 0.12, 0.35);
        else if (type === 'small_fish') {
            playSound(900, 'sine', 0.08, 0.4);
            setTimeout(() => playSound(1200, 'sine', 0.08, 0.3), 50);
        }
    }

    function createShatterEffect(x, y, color = "#ff9800", count = 12) {
        playSound(200, 'square', 0.2, 0.4); 
        for(let i=0; i<count; i++) {
            shatterParticles.push({ x, y, vx: (Math.random() - 0.5) * 14, vy: (Math.random() - 0.5) * 14, size: Math.random() * 6 + 3, life: 90, color });
        }
    }

    function createBossShatter(x, y) {
        playSound(80, 'sawtooth', 0.8, 0.5);
        for(let i=0; i<100; i++) {
            bossShatterParticles.push({ x: x + (Math.random()-0.5)*400, y: y + (Math.random()-0.5)*200, vx: (Math.random()-0.5)*25, vy: (Math.random()-0.5)*25, size: Math.random()*12+4, color: Math.random() < 0.7 ? '#8b0000' : '#ff1744', life: 100 });
        }
    }

    function updateBubbles() {
        if (!playerDying && Math.random() < 0.05) bubbles.push({ x: Math.random() * canvas.width, y: canvas.height + 20, r: Math.random() * 5 + 2, speed: Math.random() * 2 + 1 });
        bubbles.forEach((b, i) => {
            if (!playerDying && !bossDying) { b.y -= b.speed; b.x += Math.sin(Date.now() * 0.002 + b.y) * 0.5; }
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2); ctx.stroke();
            if (b.y < -20) bubbles.splice(i, 1);
        });
    }

    function drawClassicMine(x, y, radius, isBig) {
        ctx.save();
        ctx.fillStyle = isBig ? '#1a1a1a' : '#333'; ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = isBig ? 6 : 4;
        for (let a = 0; a < Math.PI * 2; a += Math.PI / 4) {
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + Math.cos(a) * (radius + (isBig ? 15 : 10)), y + Math.sin(a) * (radius + (isBig ? 15 : 10))); ctx.stroke();
        }
        ctx.fillStyle = (Math.floor(Date.now() / 200) % 2 === 0) ? 'red' : '#300'; ctx.beginPath(); ctx.arc(x, y, radius / 3, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
    }

    function drawJellyfish(x, y) {
        ctx.save(); 
        let move = (!playerDying && !bossDying) ? Math.sin(Date.now() * 0.005) * 10 : 0;
        ctx.fillStyle = 'rgba(234, 128, 252, 0.7)'; ctx.beginPath(); ctx.arc(x, y + move, 22, Math.PI, 0); ctx.fill();
        ctx.strokeStyle = 'rgba(234, 128, 252, 0.5)'; ctx.lineWidth = 3;
        for(let i = -15; i <= 15; i += 10) {
            ctx.beginPath(); ctx.moveTo(x + i, y + move);
            let tentacleSwing = (!playerDying && !bossDying) ? Math.sin(Date.now() * 0.01 + i) * 12 : 0;
            ctx.bezierCurveTo(x + i + tentacleSwing, y + move + 15, x + i - tentacleSwing, y + move + 30, x + i, y + move + 45); ctx.stroke();
        }
        ctx.restore();
    }

    const updateInput = (e) => {
        if (!gameRunning || playerStunTimer > 0 || playerDying || bossDying) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        player.targetX = (clientX - rect.left) * (canvas.width / rect.width);
        player.targetY = (clientY - rect.top) * (canvas.height / rect.height);
        if (player.targetX > player.x) player.facing = 1; else player.facing = -1;
    };
    
    canvas.addEventListener('mousemove', updateInput);
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); updateInput(e); }, { passive: false });

    function startGame() {
        initAudio();
        if (gameLoopId) cancelAnimationFrame(gameLoopId);
        document.getElementById('new-record').style.display = 'none';
        const goOverlay = document.getElementById('game-over');
        goOverlay.classList.add('hidden'); goOverlay.classList.remove('show');
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('credits-menu').classList.add('hidden');
        gameRunning = true; score = 0; hp = 100; items = []; explosions = []; bossBullets = []; bubbles = []; shockwaves = [];
        playerDying = false; deathTimer = 0; shatterParticles = []; 
        bossDying = false; bossDeathTimer = 0; bossAlpha = 1; bossSpeech.style.display = 'none'; bossShatterParticles = [];
        boss.active = false; boss.hp = 100000; boss.maxHp = 100000; boss.y = 800; bossDefeated = false; playerStunTimer = 0;
        boss.freezeTime = 0; boss.state = 'idle'; boss.targetX = 400; boss.warningX = -500;
        victoryPhase = false; victoryTimer = 0; difficultyMultiplier = 1.0;
        bossUi.style.display = 'none'; poisonTimer = 0; player.x = 400; player.y = 150; player.targetX = 400; player.targetY = 150;
        lastHungerUpdate = Date.now(); updateHPUI(); scoreDisplay.innerText = `‡πÅ‡∏ï‡πâ‡∏°: 0`;
        gameLoopId = requestAnimationFrame(animate);
    }

    function quitToMenu() { gameRunning = false; if (gameLoopId) cancelAnimationFrame(gameLoopId); document.getElementById('game-over').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); bossUi.style.display = 'none'; bossSpeech.style.display = 'none'; ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function showCredits() { document.getElementById('main-menu').classList.add('hidden'); document.getElementById('credits-menu').classList.remove('hidden'); }
    function backToMainFromCredits() { document.getElementById('credits-menu').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }

    function updateHPUI() {
        hpFill.style.width = Math.max(0, hp) + '%';
        hpFill.style.background = poisonTimer > 0 ? "#ea80fc" : (hp > 60 ? '#4caf50' : (hp > 30 ? '#ffeb3b' : '#ff5252'));
        if (hp <= 0 && gameRunning && !playerDying) {
            playerDying = true; deathTimer = 160; playSound(100, 'sawtooth', 0.5, 0.4);
            if (score > highScore) { highScore = score; localStorage.setItem('fishGameHighScore', highScore); highScoreUi.innerText = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${highScore}`; document.getElementById('new-record').style.display = 'block'; }
        }
    }

    function drawFish(x, y, color = '#ff9800', sizeScale = 1, facing = 1, isPlayer = false) {
        if (isPlayer && playerDying && deathTimer < 100) return;
        ctx.save();
        let drawX = x, drawY = y;
        if (isPlayer && playerDying && deathTimer >= 100) { drawX += (Math.random() - 0.5) * 15; drawY += (Math.random() - 0.5) * 15; }
        ctx.translate(drawX, drawY); if (facing === -1) ctx.scale(-1, 1);
        ctx.fillStyle = (poisonTimer > 0 && color === '#ff9800') ? '#ea80fc' : color;
        if (playerStunTimer > 0) ctx.globalAlpha = 0.6; 
        ctx.beginPath(); ctx.ellipse(0, 0, 30*sizeScale, 20*sizeScale, 0, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-25*sizeScale, 0); ctx.lineTo(-45*sizeScale, -15*sizeScale); ctx.lineTo(-45*sizeScale, 15*sizeScale); ctx.closePath(); ctx.fill();
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(15*sizeScale, -5*sizeScale, 5*sizeScale, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(17*sizeScale, -5*sizeScale, 2*sizeScale, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function createOldExplosion(x, y, fromBoss = false) {
        explosions.push({ x, y, r: 10, alpha: 1 });
        playSound(60, 'sawtooth', 0.5, 0.25);
        if (boss.active && !fromBoss && !bossDying) {
            let dist = Math.sqrt((x - boss.x)**2 + (y - (boss.y + 50))**2);
            if (dist < 320) { 
                boss.hp -= 1500; 
                bossHpFill.style.width = (Math.max(0, boss.hp) / boss.maxHp * 100) + '%'; 
                if (boss.hp <= 0 && !bossDying) startBossDeathSequence(); 
            }
        }
    }

    function startBossDeathSequence() { bossDying = true; bossDeathTimer = 180; boss.state = 'dying'; bossBullets = []; shockwaves = []; bossSpeech.style.display = 'none'; playSound(150, 'sawtooth', 1.0, 0.5); }

    function drawBoss() {
        if (!boss.active || (bossDying && bossDeathTimer < 20)) return;
        ctx.save(); ctx.globalAlpha = bossAlpha;
        let shake = bossDying ? (Math.random()-0.5)*40 : (!playerDying && boss.state === 'roaring' && boss.attackTimer < 40 ? (Math.random()-0.5)*35 : 0);
        ctx.translate(shake, shake);
        ctx.strokeStyle = '#8b0000'; ctx.lineWidth = 18;
        for(let i=0; i<3; i++) {
            let legMove = (!playerDying && !bossDying) ? Math.sin(Date.now() * 0.01 + i) * 20 : 0;
            [-1, 1].forEach(side => { ctx.beginPath(); ctx.moveTo(boss.x + (side * 90), boss.y + 30); ctx.lineTo(boss.x + (side * 230) + legMove, boss.y + 130); ctx.stroke(); });
        }
        [-1, 1].forEach(side => {
            ctx.save(); ctx.translate(boss.x + (side * 170), boss.y); ctx.scale(side, 1);
            let isSmashingSide = (boss.state === 'smashing' && (boss.warningX === (side === -1 ? 150 : 650) || boss.warningX === 400));
            ctx.rotate((isSmashingSide ? 1.0 : -0.3) + (!playerDying && !bossDying ? Math.sin(Date.now()*0.003)*0.1 : 0));
            ctx.fillStyle = isSmashingSide && boss.attackTimer % 50 < 45 ? (Math.floor(Date.now() / 80) % 2 === 0 ? '#ffeb3b' : '#ff1744') : '#b71c1c';
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(50, -130, 170, -70); ctx.lineTo(150, -30); ctx.lineTo(130, -50); ctx.lineTo(110, -20); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(50, 60, 160, 20); ctx.lineTo(130, -10); ctx.closePath(); ctx.fill(); ctx.restore();
        });
        ctx.fillStyle = '#8b0000'; ctx.beginPath(); ctx.ellipse(boss.x, boss.y + 50, boss.width, boss.height, 0, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(boss.x-70, boss.y, 40, 0, Math.PI*2); ctx.arc(boss.x+70, boss.y, 40, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(boss.x-70, boss.y-10, 18, 0, Math.PI*2); ctx.arc(boss.x+70, boss.y-10, 18, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function animate() {
        if (!gameRunning && !playerDying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        updateBubbles();

        shatterParticles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life--; ctx.fillStyle = p.color || "#ff9800"; ctx.fillRect(p.x, p.y, p.size, p.size); if (p.life <= 0) shatterParticles.splice(i, 1); });
        bossShatterParticles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--; ctx.globalAlpha = p.life / 100; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); ctx.globalAlpha = 1.0; if (p.life <= 0) bossShatterParticles.splice(i, 1); });

        if (playerDying) {
            deathTimer--; if (deathTimer === 100) createShatterEffect(player.x, player.y);
            if (deathTimer === 20) { gameRunning = false; const go = document.getElementById('game-over'); go.classList.remove('hidden'); setTimeout(() => go.classList.add('show'), 10); document.getElementById('final-score').innerText = `‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${score}`; }
        }

        if (gameRunning && !playerDying) {
            let now = Date.now();
            difficultyMultiplier = bossDefeated ? (1.0 + Math.max(0, (score - 15000) / 20000)) : (1.0 + Math.min(0.5, score / 10000));

            if (bossDying) {
                bossDeathTimer--;
                if (bossDeathTimer > 20) { bossSpeech.innerText = "‡∏û‡∏µ‡πà‡∏à‡πã‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß"; bossSpeech.style.display = 'block'; bossSpeech.style.left = (boss.x - 100) + 'px'; bossSpeech.style.top = (boss.y - 120) + 'px'; }
                if (bossDeathTimer === 20) { createBossShatter(boss.x, boss.y); bossAlpha = 0; bossSpeech.style.display = 'none'; }
                if (bossDeathTimer <= 0) { boss.active = false; bossDying = false; bossDefeated = true; bossUi.style.display = 'none'; score += 10000; scoreDisplay.innerText = `‡πÅ‡∏ï‡πâ‡∏°: ${score}`; victoryPhase = true; victoryTimer = 600; }
            } else {
                // --- ‡∏£‡∏∞‡∏ö‡∏ö Alert ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ï‡πâ‡∏° ---
                if (victoryPhase) { statusAlert.innerText = "‚≠ê VICTORY! ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‚≠ê"; statusAlert.style.color = "#ffeb3b"; victoryTimer--; if (Math.random() < 0.15) explosions.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: 5, alpha: 1 }); if (victoryTimer <= 0) { victoryPhase = false; statusAlert.innerText = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡πÑ‡∏£‡πâ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!"; } } 
                else if (boss.active) { statusAlert.innerText = "üí¢ ‡∏ö‡∏≠‡∏™‡∏õ‡∏π‡∏Ñ‡∏•‡∏±‡πà‡∏á! HP " + Math.max(0, Math.floor(boss.hp)); statusAlert.style.color = "#ff1744"; } 
                else if (bossDefeated) { statusAlert.innerText = "‡πÇ‡∏´‡∏°‡∏î‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (‡∏£‡∏∞‡∏î‡∏±‡∏ö: " + difficultyMultiplier.toFixed(2) + ")"; statusAlert.style.color = "#4caf50"; }
                else {
                    if (score >= 2000) { statusAlert.innerText = "üëæ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏°‡∏á‡∏Å‡∏∞‡∏û‡∏£‡∏∏‡∏ô‡∏û‡∏¥‡∏©!"; statusAlert.style.color = "#ea80fc"; }
                    else if (score >= 1000) { statusAlert.innerText = "üí£ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ó‡∏∏‡πà‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏¢‡∏±‡∏Å‡∏©‡πå!"; statusAlert.style.color = "#ff5252"; }
                    else if (score >= 500) { statusAlert.innerText = "‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ó‡∏∏‡πà‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î!"; statusAlert.style.color = "#ffffff"; }
                    else { statusAlert.innerText = "‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏™‡∏π‡πâ‡∏ö‡∏≠‡∏™!"; statusAlert.style.color = "#ffeb3b"; }
                }
                
                if (playerStunTimer > 0) playerStunTimer--;
                if (boss.active && boss.freezeTime > 0) { boss.freezeTime--; if (boss.y > 450) boss.y -= 2; ctx.fillStyle = "white"; ctx.font = `bold 30px Tahoma`; ctx.textAlign = "center"; ctx.fillText("!!! MEGA BOSS CRAB !!!", 400, 200); }
                else if (!boss.active || (boss.active && boss.freezeTime <= 0)) {
                    if (now - lastHungerUpdate > (bossDefeated ? 1200 : 1000)) { hp -= 3; updateHPUI(); lastHungerUpdate = now; }
                    if (poisonTimer > 0) { hp -= 0.5; poisonTimer--; updateHPUI(); }
                    
                    if (playerStunTimer <= 0) {
                        player.x += (player.targetX - player.x) * 0.12;
                        player.y += (player.targetY - player.y) * 0.12;
                        if (boss.active && !bossDying) {
                            let distToBossX = Math.abs(player.x - boss.x);
                            let distToBossY = Math.abs(player.y - (boss.y + 50));
                            if (distToBossX < boss.width - 20 && distToBossY < boss.height - 10) {
                                if (player.x < boss.x) player.x -= 15; else player.x += 15;
                                if (player.y < boss.y + 50) player.y -= 15; else player.y += 15;
                                player.targetX = player.x; player.targetY = player.y;
                            }
                        }
                    }
                    
                    let spawnProb = victoryPhase ? 0.5 : (0.12 * difficultyMultiplier);
                    if (Math.random() < spawnProb) {
                        let type = 'food', br = Math.random();
                        if (victoryPhase) { if (br < 0.4) type = 'food'; else if (br < 0.8) type = 'worm'; else type = 'small_fish'; } 
                        else if (boss.active) { if (br < 0.35) type = 'food'; else if (br < 0.50) type = 'mine'; else if (br < 0.65) type = 'small_fish'; else if (br < 0.75) type = 'worm'; else if (br < 0.88) type = 'big_mine'; else if (br < 0.89) type = 'jellyfish'; else type = 'trash'; } 
                        else { if (br < 0.12*difficultyMultiplier) type = 'trash'; else if (br < 0.22) type = 'worm'; else if (br < 0.32) type = 'small_fish'; else if (br < 0.65 && (score >= 500 || bossDefeated)) { let rd = Math.random(); if ((score >= 2000 || bossDefeated) && rd < 0.3) type = 'jellyfish'; else if ((score >= 1000 || bossDefeated) && rd < 0.6) type = 'big_mine'; else type = 'mine'; } }
                        items.push({ x: Math.random()*740+30, y: -50, type, speed: (victoryPhase ? (Math.random()*2+6) : (Math.random()*2+3)) * Math.min(2.5, difficultyMultiplier) });
                    }
                }

                if (score >= 5000 && !boss.active && !bossDefeated) { boss.active = true; bossUi.style.display = 'block'; boss.freezeTime = 180; boss.x = 400; boss.y = 800; items = []; explosions = []; shockwaves = []; }

                if (boss.active && boss.freezeTime <= 0) {
                    boss.attackTimer++;
                    if (boss.state === 'idle' && boss.attackTimer > 60) {
                        let r = Math.random();
                        if (r < 0.15) { boss.state = 'roaring'; boss.attackTimer = 0; }
                        else if (r < 0.75) { boss.state = 'moving'; let p = Math.random(); if (p < 0.33) boss.targetX = 150; else if (p < 0.66) boss.targetX = 400; else boss.targetX = 650; }
                        else { boss.state = 'smashing'; boss.attackTimer = 0; }
                    }
                    if (boss.state === 'roaring') { if (boss.attackTimer === 1) { for(let i=0; i<5; i++) { setTimeout(() => { if(!playerDying && gameRunning && !bossDying) { shockwaves.push({x: boss.x, y: boss.y + 50, r: 0, a: 1}); playSound(130 - (i*15), 'sawtooth', 0.4, 0.4); } }, i * 60); } playerStunTimer = 60; } if (boss.attackTimer > 90) boss.state = 'idle'; }
                    if (boss.state === 'moving') { boss.x += (boss.targetX - boss.x) * 0.08; if (Math.abs(boss.x - boss.targetX) < 5) { boss.state = 'shooting'; boss.attackTimer = 0; } } 
                    else if (boss.state === 'shooting') { if (boss.attackTimer % 2 === 0) { for(let o = -100; o <= 100; o += 40) bossBullets.push({x: boss.x + o, y: boss.y - 20, vx: (Math.random()-0.5)*3, vy: -15, r: 10}); playSound(1100, 'sine', 0.05, 0.03); } if (boss.attackTimer > 80) boss.state = 'idle'; } 
                    else if (boss.state === 'smashing') {
                        if (boss.attackTimer === 41) { createOldExplosion(150, 300, true); if (player.x > 30 && player.x < 270) { hp -= 40; updateHPUI(); } }
                        if (boss.attackTimer === 91) { createOldExplosion(650, 300, true); if (player.x > 530 && player.x < 770) { hp -= 40; updateHPUI(); } }
                        if (boss.attackTimer === 141) { createOldExplosion(400, 300, true); if (player.x > 280 && player.x < 520) { hp -= 40; updateHPUI(); } }
                        if (boss.attackTimer > 160) boss.state = 'idle';
                        boss.warningX = boss.attackTimer < 50 ? 150 : (boss.attackTimer < 100 ? 650 : 400);
                    }
                }
            }
        }

        shockwaves.forEach((s, i) => { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.strokeStyle = `rgba(255, 255, 255, ${s.a})`; ctx.lineWidth = 5; ctx.stroke(); if (!playerDying && !bossDying) { s.r += 16; s.a -= 0.025; } if (s.a <= 0) shockwaves.splice(i, 1); });
        if (!playerDying && !bossDying && boss.active && boss.state === 'smashing' && boss.attackTimer % 10 < 8) { ctx.fillStyle = (Math.floor(Date.now() / 80) % 2 === 0) ? 'rgba(255, 235, 59, 0.3)' : 'rgba(255, 0, 0, 0.3)'; ctx.fillRect(boss.warningX - 120, 0, 240, 600); if (boss.attackTimer === 41 || boss.attackTimer === 91 || boss.attackTimer === 141) { for(let j = items.length - 1; j >= 0; j--) { if (items[j].x > boss.warningX - 120 && items[j].x < boss.warningX + 120) items.splice(j, 1); } } }

        bossBullets.forEach((b, i) => { if (!playerDying && !bossDying) { b.y += b.vy; b.x += b.vx; items.forEach((item, idx) => { if (Math.sqrt((item.x - b.x)**2 + (item.y - b.y)**2) < 35) { if (item.type.includes('mine')) createOldExplosion(item.x, item.y, true); items.splice(idx, 1); bossBullets.splice(i, 1); } }); } ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); if (!playerDying && !bossDying && Math.sqrt((player.x-b.x)**2+(player.y-b.y)**2) < 35) { hp -= 8; updateHPUI(); bossBullets.splice(i, 1); playSound(100, 'square', 0.1, 0.2); } if (b.y < -50 || b.x < -50 || b.x > 850) bossBullets.splice(i, 1); });
        explosions.forEach((e, i) => { ctx.save(); ctx.strokeStyle = `rgba(255, 255, 255, ${e.alpha})`; ctx.lineWidth = 6; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.stroke(); if (!playerDying && !bossDying) { e.r += 12; e.alpha -= 0.04; } if (e.alpha <= 0) explosions.splice(i, 1); ctx.restore(); });

        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i]; if (!playerDying && !bossDying) item.y += item.speed;
            if (item.type === 'food') { ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(item.x, item.y, 8, 0, Math.PI*2); ctx.fill(); }
            else if (item.type === 'worm') { ctx.fillStyle = '#ff80ab'; ctx.fillRect(item.x-15, item.y-5, 30, 10); }
            else if (item.type === 'small_fish') { drawFish(item.x, item.y, '#00e5ff', 0.6, 1); }
            else if (item.type === 'trash') { ctx.fillStyle = '#9e9e9e'; ctx.fillRect(item.x-12, item.y-12, 24, 24); }
            else if (item.type === 'mine') { drawClassicMine(item.x, item.y, 15, false); }
            else if (item.type === 'big_mine') { drawClassicMine(item.x, item.y, 30, true); }
            else if (item.type === 'jellyfish') drawJellyfish(item.x, item.y);
            
            if (!playerDying && !bossDying) {
                if (boss.active && Math.sqrt((item.x - boss.x)**2 + (item.y - (boss.y + 50))**2) < 200) { if (item.type.includes('mine')) createOldExplosion(item.x, item.y); items.splice(i, 1); continue; }
                if (Math.sqrt((player.x - item.x)**2 + (player.y - item.y)**2) < 45) {
                    if (item.type.includes('mine')) { createOldExplosion(item.x, item.y); hp -= (item.type === 'big_mine' ? 50 : 30); }
                    else if (item.type === 'food') { score += 10; hp = Math.min(100, hp + 5); playEatSound('food'); }
                    else if (item.type === 'worm') { score += 25; hp = Math.min(100, hp + 15); playEatSound('worm'); }
                    else if (item.type === 'small_fish') { score += 100; hp = Math.min(100, hp + 40); playEatSound('small_fish'); }
                    else if (item.type === 'trash') { hp -= 15; playSound(120, 'square', 0.2, 0.3); }
                    else if (item.type === 'jellyfish') { poisonTimer = 150; playSound(350, 'square', 0.4, 0.4); }
                    items.splice(i, 1); scoreDisplay.innerText = `‡πÅ‡∏ï‡πâ‡∏°: ${score}`; updateHPUI(); continue;
                }
            }
            if (item.y > 650) items.splice(i, 1);
        }

        drawBoss(); 
        drawFish(player.x, player.y, '#ff9800', 1, player.facing, true);

        // Victory Text (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!)
        if (victoryPhase) {
            ctx.save();
            ctx.fillStyle = 'white'; ctx.shadowBlur = 20; ctx.shadowColor = 'yellow';
            ctx.font = 'bold 60px Tahoma'; ctx.textAlign = 'center';
            ctx.fillText("VICTORY!", 400, 300);
            ctx.font = 'bold 24px Tahoma';
            ctx.fillText("‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πâ‡∏≤!", 400, 350);
            ctx.restore();
        }

        gameLoopId = requestAnimationFrame(animate);
    }
</script>
</body>
</html>
