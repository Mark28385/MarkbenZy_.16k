<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fish Adventure: Mobile Edition - By Chayanan</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #01579b; font-family: 'Tahoma', sans-serif; overflow: hidden; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; max-width: 800px; max-height: 1000px; overflow: hidden; background: linear-gradient(#4fc3f7, #01579b); }
        canvas { width: 100%; height: 100%; display: block; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.8); color: white; z-index: 10; text-align: center; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .menu-btn { padding: 15px 30px; margin: 10px; font-size: 20px; cursor: pointer; border: none; border-radius: 50px; background: #ffeb3b; color: #01579b; font-weight: bold; }
        .hp-bar-container { position: absolute; top: 15px; right: 15px; width: 120px; height: 15px; background: #333; border: 2px solid white; border-radius: 10px; }
        #hp-fill { width: 100%; height: 100%; background: #4caf50; transition: 0.1s; }
        #boss-ui { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 80%; height: 12px; background: #333; border: 2px solid white; display: none; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff1744; }
        #status-ui { position: absolute; top: 15px; left: 15px; color: #ffeb3b; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="status-ui">คะแนน: 0</div>
    <div class="hp-bar-container"><div id="hp-fill"></div></div>
    <div id="boss-ui"><div id="boss-hp-fill"></div></div>

    <div id="main-menu" class="overlay">
        <h2>FISH ADVENTURE</h2>
        <p>แตะค้างแล้วลากเพื่อว่ายน้ำหลบศัตรู!</p>
        <button class="menu-btn" onclick="startGame()">เริ่มเล่นเกม</button>
    </div>

    <div id="game-over" class="overlay hidden">
        <h2 id="end-title">จบเกม</h2>
        <p id="final-score"></p>
        <button class="menu-btn" onclick="startGame()">เล่นอีกครั้ง</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hpFill = document.getElementById('hp-fill');
    const bossUi = document.getElementById('boss-ui');
    const bossHpFill = document.getElementById('boss-hp-fill');
    const statusUi = document.getElementById('status-ui');

    let w, h, gameRunning = false, score = 0, hp = 100;
    let items = [], bubbles = [], effects = [], lastHunger = 0;
    let player = { x: 0, y: 0, targetX: 0, targetY: 0, size: 1, facing: 1 };
    let boss = { active: false, x: 0, y: 0, hp: 600, maxHp: 600 };

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        player.x = player.targetX = w / 2;
        player.y = player.targetY = h / 2;
    }
    window.addEventListener('resize', resize);
    resize();

    // ระบบควบคุมด้วยการ Touch / Mouse
    const handleMove = (e) => {
        if (!gameRunning) return;
        const touch = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        player.targetX = touch.clientX - rect.left;
        player.targetY = touch.clientY - rect.top;
    };
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, { passive: false });

    function startGame() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        gameRunning = true; score = 0; hp = 100; items = []; effects = [];
        boss.active = false; boss.hp = 600; bossUi.style.display = 'none';
        lastHunger = Date.now();
        animate();
    }

    function drawFish(x, y, color, scale, facing) {
        ctx.save();
        ctx.translate(x, y);
        if (facing < 0) ctx.scale(-1, 1);
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.ellipse(0, 0, 25*scale, 15*scale, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-20*scale, 0); ctx.lineTo(-35*scale, -12*scale); ctx.lineTo(-35*scale, 12*scale); ctx.closePath(); ctx.fill();
        ctx.restore();
    }

    function drawBoss() {
        if (!boss.active) return;
        ctx.fillStyle = '#b71c1c';
        ctx.beginPath(); ctx.ellipse(boss.x, boss.y, 60, 40, 0, 0, Math.PI*2); ctx.fill();
        // วาดขา 6 ข้างแบบง่ายสำหรับมือถือ
        ctx.strokeStyle = '#b71c1c'; ctx.lineWidth = 5;
        for(let i=0; i<3; i++) {
            let offset = Math.sin(Date.now()*0.01 + i) * 10;
            ctx.beginPath(); ctx.moveTo(boss.x-40, boss.y+i*10); ctx.lineTo(boss.x-70-offset, boss.y+30+i*10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(boss.x+40, boss.y+i*10); ctx.lineTo(boss.x+70+offset, boss.y+30+i*10); ctx.stroke();
        }
    }

    function animate() {
        if (!gameRunning) return;
        ctx.clearRect(0, 0, w, h);

        // ย้ายตัวปลาตามเป้าหมาย
        let dx = player.targetX - player.x;
        let dy = player.targetY - player.y;
        player.x += dx * 0.1;
        player.y += dy * 0.1;
        if (dx !== 0) player.facing = dx > 0 ? 1 : -1;

        if (Date.now() - lastHunger > 1000) { hp -= 3; lastHunger = Date.now(); }
        hpFill.style.width = hp + '%';
        if (hp <= 0) { gameRunning = false; document.getElementById('game-over').classList.remove('hidden'); }

        if (score >= 3000 && !boss.active) { boss.active = true; boss.x = w/2; boss.y = h + 100; bossUi.style.display = 'block'; }
        if (boss.active) {
            if (boss.y > h - 150) boss.y -= 1;
            boss.x += (player.x - boss.x) * 0.02;
            drawBoss();
            if (Math.hypot(player.x-boss.x, player.y-boss.y) < 80) { hp -= 1; }
        }

        drawFish(player.x, player.y, '#ff9800', 1, player.facing);

        if (Math.random() < 0.05) {
            let type = Math.random() < 0.2 ? 'mine' : 'food';
            if (boss.active && Math.random() < 0.3) type = 'mine';
            items.push({ x: Math.random()*w, y: -20, type });
        }

        items.forEach((item, i) => {
            item.y += 3;
            ctx.fillStyle = item.type === 'food' ? '#ffeb3b' : '#333';
            ctx.beginPath(); ctx.arc(item.x, item.y, 10, 0, Math.PI*2); ctx.fill();

            let d = Math.hypot(player.x - item.x, player.y - item.y);
            if (d < 30) {
                if (item.type === 'food') { score += 10; hp = Math.min(100, hp + 5); }
                else { hp -= 20; }
                items.splice(i, 1);
            }

            if (boss.active && item.type === 'mine') {
                if (Math.hypot(boss.x - item.x, boss.y - item.y) < 70) {
                    boss.hp -= 50; items.splice(i, 1);
                    bossHpFill.style.width = (boss.hp/600*100) + '%';
                    if (boss.hp <= 0) { score += 5000; gameRunning = false; document.getElementById('end-title').innerText = "ชนะแล้ว!"; document.getElementById('game-over').classList.remove('hidden'); }
                }
            }
            if (item.y > h + 20) items.splice(i, 1);
        });

        statusUi.innerText = `คะแนน: ${score}`;
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
